when RULE_INIT {
    # enable (1) / disable (0) logging
    set static::debug_logging 1
}
when HTTP_REQUEST {
  if {[HTTP::method] eq "POST"} {
    catch {
        if { [URI::decode [HTTP::request]] matches_regex {\$\{jndi:(ldap[s]?|rmi|dns):/[^\n]+} } {
            if { $static::debug_logging } { log local0. "Rejected because HTTP request suspicious to be CVE-2021-44228" }
            reject
        }
    }
    if {[HTTP::header "Content-Length"] ne "" && [HTTP::header "Content-Length"] <= 1048576}{
      set content_length [HTTP::header "Content-Length"]
    } else {
        set content_length 1048576
    }
    if { $content_length > 0} {
      HTTP::collect $content_length
    }
  }
}
when HTTP_REQUEST_DATA {
    catch {
        if { [string tolower [URI::decode [HTTP::payload]]] matches_regex {\$\{jndi:(ldap[s]?|rmi|dns):/[^\n]+} } {
            if { $static::debug_logging } { log local0. "Rejected because HTTP payload suspicious to be CVE-2021-44228" }
            reject
        }
    }
    HTTP::release
}